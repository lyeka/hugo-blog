---
title: "分布式ID生成器"
date: 2020-03-09
keywords: ["hugo"]
description: "分布式ID生成器"
tags: ["分布式", "go"]
categories: ["tech"]
isCJKLanguage: true
---
# 分布式ID生成器

- snowflake
- sonyflake

## snowflake

twitter开源的分布式ID生成算法。保证在不借助第三方服务或者工具的情况，在多台机器上持续生成

保证唯一性的64位整型ID



Go版本实现：https://github.com/bwmarrin/snowflake



### 原理解析

#### ID组成

64位划分成四块

- 递增序号（12）
- 节点ID（5）
- 数据中心ID（5）
- 时间戳（42）



**数据中心与节点ID**

数据中心对应云服务器是指不同的云服务提供商，如阿里云，亚马逊云？

节点对应该数据中心下的某台机器？



**时间戳**

使用的时间戳为unix时间戳，时间精度为ms（有待考征），因为位数有限（42），当经过一段时间后第42位（整个ID最高位）会增长为1，该位为64位整型的最高位，导致出现负数。

所以一般会使用基准时间减少位数，即用unix时间戳减去基准时间当作时间戳，这样可以减少时间戳的长度，延后位数不够导致负数出现的时间。但这个时间一般为几十年，大部分系统需要考虑这点吧。。

snowflake默认基准时间为1288834974657，即2010/11/4 9:42:54.657。支持自定义。



**递增序号**

单单时间戳不够，因为时间景内（1ms）内可能需要生成多个请求，所以仍需要一个递增序号唯一标识。12位支持1ms内生成4096个唯一ID，当超出时会阻塞（具体看实现）。

snowflake同样支持自定义该位数，但要受整体id位数保持在64位的限制。



### 问题与解决

#### 节点ID怎么确定和增长

可以使用第三方服务例如mysql生成每台机器的ID，但会增加依赖；

也可直接写进配置，但无法自动化增长，新建实例需要收到写配置；



#### ID重复

可能由于

- 机器获取时间出现问题，导致时间回退
  - 。。修复机器？
- 基准时间修改（回退）
  - 不要修改基准时间
- 重启在时间精度内（1ms），递增序号重复
  - 大部分系统重启不会在1ms内？



## sonyflake

索尼开源的分布式唯一ID生成算法，原理应该和snowflake差不多吧， 都是ID分片。

有空看看



参考

- https://mp.weixin.qq.com/s/a_g6wy4DzkAmc-i1Wen3XA



